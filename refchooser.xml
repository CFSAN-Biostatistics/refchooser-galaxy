<tool id="refchooser" name="Refchooser" version="0.2.1" python_template_version="3.5" profile="21.05">
    <description>Select centroidal assembly from a collection of closely-related assemblies, for reference purposes</description>
    <requirements>
        <container type="docker">cfsanbiostatistics/refchooser:0.2.1</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir ./assemblies &&
        #for assembly in $assemblies
            ln -sf '$assembly' ./assemblies/${assembly.element_identifier.replace(": ", ".").replace(" ", "_")}.fasta &&
        #end for
        refchooser sketch ./assemblies ./sketches &&
        refchooser matrix ./assemblies ./sketches ${matrix} &&
        export BEST=\$(refchooser metrics --sort Mean_Distance --top 1 ./assemblies ./sketches | tail -n 1 | cut -f 1) &&
        echo "*** best accession \$BEST ***" >&2 &&
        echo "\$BEST" > $best &&
        cat ./assemblies/\$BEST.fasta > $output
    ]]></command>
    <inputs>
        <param type="data_collection" collection_type="list" name="assemblies" format="fasta" />
    </inputs>
    <outputs>
        <data name="matrix" label="Distance matrix" format="tsv" hidden="false" />
        <data name="best" label="Name of centroidal assembly" format="txt" hidden="true" />
        <data name="output" label="Centroidal assembly..." format="fasta">
            <actions>
                <!-- copy the text from best into the label of this output-->
                <action type="metadata" name="label" default="${best}" />
            </actions>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="assemblies">
                <collection type="list">
                    <element name="SRR498285" value="test/reference_selection/assemblies/SRR498285_contigs.fasta" />
                    <element name="SRR498286" value="test/reference_selection/assemblies/SRR498286_contigs.fasta" />
                    <element name="SRR498361" value="test/reference_selection/assemblies/SRR498361_contigs.fasta" />
                    <element name="SRR498363" value="test/reference_selection/assemblies/SRR498363_contigs.fasta" />
                    <element name="SRR498372" value="test/reference_selection/assemblies/SRR498372_contigs.fasta" />
                    <element name="SRR498379" value="test/reference_selection/assemblies/SRR498379_contigs.fasta" />
                    <element name="SRR498381" value="test/reference_selection/assemblies/SRR498381_contigs.fasta" />
                    <element name="SRR498384" value="test/reference_selection/assemblies/SRR498384_contigs.fasta" />
                    <element name="SRR498386" value="test/reference_selection/assemblies/SRR498386_contigs.fasta" />
                    <element name="SRR498387" value="test/reference_selection/assemblies/SRR498387_contigs.fasta" />
                </collection>
            </param>
            <output name="output" value="test/reference_selection/assemblies/SRR498286_contigs.fasta" />
        </test>
    </tests>
    <help><![CDATA[
        Some important help text.
    ]]></help>
    <citations>
        <citation type="bibtex">
@misc{githubrefchooser,
  author = {Davis, Steven},
  year = {2019},
  title = {Refchooser},
  publisher = {GitHub},
  journal = {GitHub repository},
  url = {https://refchooser.readthedocs.io/en/latest/},
}</citation>
    </citations>
</tool>